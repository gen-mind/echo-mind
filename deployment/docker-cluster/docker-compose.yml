# docker-compose.yml
# Local development - all URLs configured via .env
# Ports exposed for debugging, no SSL

networks:
  frontend:
    driver: bridge
  backend:
    driver: bridge

volumes:
  postgres_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH}/postgres

  qdrant_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH}/qdrant

  minio_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH}/minio

  nats_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH}/nats

services:
  # ===============================================
  # Traefik - Reverse Proxy
  # ===============================================
  traefik:
    image: traefik:3.1.6
    container_name: echomind-traefik
    hostname: traefik
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"  # Traefik dashboard
    networks:
      - frontend
      - backend
    volumes:
      - ${DATA_PATH}/traefik/certificates:/letsencrypt
      - /var/run/docker.sock:/var/run/docker.sock:ro
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    command:
      - "--api.dashboard=true"
      - "--ping=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--log.level=INFO"
      - "--metrics.prometheus=true"
      - "--metrics.prometheus.entrypoint=traefik"
    labels:
      - "traefik.enable=true"

  # ===============================================
  # PostgreSQL - Shared DB (Authentik + API)
  # ===============================================
  postgres:
    image: postgres:16.4
    container_name: echomind-postgres
    hostname: postgres
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - TZ=${TZ:-UTC}
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER}']
      start_period: 30s
      interval: 10s
      timeout: 10s
      retries: 5
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ${CONFIG_PATH}/postgres/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    restart: unless-stopped
    networks:
      - backend
    labels:
      - "traefik.enable=false"

  # ===============================================
  # Adminer - PostgreSQL Web UI (Protected by Authentik)
  # ===============================================
  adminer:
    image: adminer:4.8.1-standalone
    container_name: echomind-adminer
    hostname: adminer
    ports:
      - "8081:8080"  # Exposed for local development
    environment:
      - ADMINER_DEFAULT_SERVER=postgres
      - ADMINER_DESIGN=pepa-linha-dark
      - ADMINER_PLUGINS=tables-filter tinymce
    restart: unless-stopped
    networks:
      - backend
      - frontend
    depends_on:
      postgres:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.adminer.rule=Host(`${POSTGRES_DOMAIN}`)"
      - "traefik.http.routers.adminer.entrypoints=web"
      - "traefik.http.services.adminer.loadbalancer.server.port=8080"

  # ===============================================
  # Authentik Server - OIDC Provider
  # ===============================================
  authentik-server:
    image: ghcr.io/goauthentik/server:2025.10.3
    container_name: echomind-authentik-server
    hostname: authentik-server
    command: server
    environment:
      - AUTHENTIK_POSTGRESQL__HOST=postgres
      - AUTHENTIK_POSTGRESQL__USER=${POSTGRES_USER}
      - AUTHENTIK_POSTGRESQL__NAME=${AUTHENTIK_DB_NAME}
      - AUTHENTIK_POSTGRESQL__PASSWORD=${POSTGRES_PASSWORD}
      - AUTHENTIK_SECRET_KEY=${AUTHENTIK_SECRET_KEY}
    volumes:
      - ${DATA_PATH}/authentik/media:/media
      - ${DATA_PATH}/authentik/custom-templates:/templates
    depends_on:
      - postgres
    restart: unless-stopped
    networks:
      - frontend
      - backend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.authentik.rule=Host(`${AUTHENTIK_DOMAIN}`)"
      - "traefik.http.routers.authentik.entrypoints=web"
      - "traefik.http.routers.authentik.middlewares=authentik-cors"
      - "traefik.http.services.authentik.loadbalancer.server.port=9000"
      # CORS middleware for OIDC endpoints (required for SPA clients)
      - "traefik.http.middlewares.authentik-cors.headers.accesscontrolallowmethods=GET,OPTIONS,POST"
      - "traefik.http.middlewares.authentik-cors.headers.accesscontrolallowheaders=*"
      - "traefik.http.middlewares.authentik-cors.headers.accesscontrolalloworiginlist=${CORS_ORIGINS}"
      - "traefik.http.middlewares.authentik-cors.headers.accesscontrolallowcredentials=true"
      - "traefik.http.middlewares.authentik-cors.headers.accesscontrolmaxage=100"
      - "traefik.http.middlewares.authentik-cors.headers.addvaryheader=true"

  # ===============================================
  # Authentik Worker - Background Tasks
  # ===============================================
  authentik-worker:
    image: ghcr.io/goauthentik/server:2025.10.3
    container_name: echomind-authentik-worker
    hostname: authentik-worker
    command: worker
    environment:
      - AUTHENTIK_POSTGRESQL__HOST=postgres
      - AUTHENTIK_POSTGRESQL__USER=${POSTGRES_USER}
      - AUTHENTIK_POSTGRESQL__NAME=${AUTHENTIK_DB_NAME}
      - AUTHENTIK_POSTGRESQL__PASSWORD=${POSTGRES_PASSWORD}
      - AUTHENTIK_SECRET_KEY=${AUTHENTIK_SECRET_KEY}
      - AUTHENTIK_BOOTSTRAP_PASSWORD=${AUTHENTIK_BOOTSTRAP_PASSWORD}
      - AUTHENTIK_BOOTSTRAP_EMAIL=${AUTHENTIK_BOOTSTRAP_EMAIL}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${DATA_PATH}/authentik/media:/media
      - ${DATA_PATH}/authentik/custom-templates:/templates
      - ${DATA_PATH}/authentik/certs:/certs
    depends_on:
      - postgres
    restart: unless-stopped
    networks:
      - backend

  # ===============================================
  # Qdrant - Vector Database
  # ===============================================
  qdrant:
    image: qdrant/qdrant:latest
    container_name: echomind-qdrant
    hostname: qdrant
    ports:
      - "6333:6333"  # HTTP API
      - "6334:6334"  # gRPC API
    volumes:
      - qdrant_data:/qdrant/storage
      - ${CONFIG_PATH}/qdrant/production.yaml:/qdrant/config/production.yaml
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c '</dev/tcp/localhost/6333' || exit 1"]
      start_period: 30s
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - backend
    labels:
      - "traefik.enable=false"

  # ===============================================
  # MinIO - Object Storage
  # ===============================================
  minio:
    image: minio/minio:latest
    container_name: echomind-minio
    hostname: minio
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
      - MINIO_PROMETHEUS_AUTH_TYPE=public
    ports:
      - "9000:9000"  # API
      - "9001:9001"  # Console
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    restart: unless-stopped
    networks:
      - frontend
      - backend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.minio-console.rule=Host(`${MINIO_DOMAIN}`)"
      - "traefik.http.routers.minio-console.entrypoints=web"
      - "traefik.http.services.minio-console.loadbalancer.server.port=9001"

  # ===============================================
  # NATS - Message Bus
  # ===============================================
  nats:
    image: nats:alpine
    container_name: echomind-nats
    hostname: nats
    ports:
      - "4222:4222"  # Client connections
      - "8222:8222"  # HTTP monitoring
      - "6222:6222"  # Cluster routes
    volumes:
      - nats_data:/data/nats
      - ${CONFIG_PATH}/nats/nats-server.conf:/nats-server.conf
    command:
      - "--config=/nats-server.conf"
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O /dev/null http://localhost:8222/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    restart: unless-stopped
    networks:
      - backend
    labels:
      - "traefik.enable=false"

  # ===============================================
  # Nui - NATS Management UI (Protected by Authentik)
  # ===============================================
  nui:
    image: ghcr.io/nats-nui/nui:latest
    container_name: echomind-nui
    hostname: nui
    ports:
      - "31311:31311"  # Exposed for local development
    environment:
      # NATS connection defaults
      - NUI_NATS_URL=nats://nats:4222
      - NUI_NATS_NAME=EchoMind NATS
      # Server configuration
      - NUI_SERVER_PORT=31311
      - NUI_SERVER_HOST=0.0.0.0
      # Authentication disabled (handled by Traefik ForwardAuth)
      - NUI_SERVER_AUTH_ENABLED=false
    restart: unless-stopped
    networks:
      - backend
      - frontend
    depends_on:
      nats:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nui.rule=Host(`${NATS_DOMAIN}`)"
      - "traefik.http.routers.nui.entrypoints=web"
      - "traefik.http.services.nui.loadbalancer.server.port=31311"

  # ===============================================
  # EchoMind API - FastAPI Application
  # ===============================================
  api:
    image: gsantopaolo/echomind-api:${API_VERSION:-0.1.0-beta.1}
    build:
      context: ../../src
      dockerfile: api/Dockerfile
    container_name: echomind-api
    hostname: api
    env_file:
      - ${CONFIG_PATH}/api/api.env
    environment:
      - API_DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${API_DB_NAME}
      - API_QDRANT_HOST=qdrant
      - API_QDRANT_PORT=6333
      - API_MINIO_ENDPOINT=minio:9000
      - API_MINIO_ACCESS_KEY=${MINIO_ROOT_USER}
      - API_MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD}
      - API_NATS_URL=nats://nats:4222
      # Auth - issuer must match JWT's 'iss' claim exactly (external URL)
      - API_AUTH_ISSUER=${API_AUTH_ISSUER}
      - API_AUTH_AUDIENCE=${API_AUTH_AUDIENCE}
      - API_AUTH_JWKS_URL=${API_AUTH_JWKS_URL}
    depends_on:
      postgres:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      migration:
        condition: service_completed_successfully
      minio:
        condition: service_healthy
      nats:
        condition: service_started
      authentik-server:
        condition: service_started
    restart: unless-stopped
    networks:
      - frontend
      - backend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`${API_DOMAIN}`)"
      - "traefik.http.routers.api.entrypoints=web"
      - "traefik.http.routers.api.middlewares=api-cors"
      - "traefik.http.services.api.loadbalancer.server.port=8000"
      # CORS middleware for API (required for SPA)
      - "traefik.http.middlewares.api-cors.headers.accesscontrolallowmethods=GET,OPTIONS,PUT,POST,DELETE,PATCH"
      - "traefik.http.middlewares.api-cors.headers.accesscontrolallowheaders=*"
      - "traefik.http.middlewares.api-cors.headers.accesscontrolalloworiginlist=${CORS_ORIGINS}"
      - "traefik.http.middlewares.api-cors.headers.accesscontrolallowcredentials=true"
      - "traefik.http.middlewares.api-cors.headers.accesscontrolmaxage=100"
      - "traefik.http.middlewares.api-cors.headers.addvaryheader=true"

  # ===============================================
  # EchoMind Migration - Database Migrations
  # ===============================================
  migration:
    image: gsantopaolo/echomind-migration:${MIGRATION_VERSION:-0.1.0-beta.1}
    build:
      context: ../../src
      dockerfile: migration/Dockerfile
    container_name: echomind-migration
    hostname: migration
    env_file:
      - ${CONFIG_PATH}/migration/migration.env
    environment:
      - MIGRATION_DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${API_DB_NAME}
    depends_on:
      postgres:
        condition: service_healthy
    restart: "no"
    networks:
      - backend
    labels:
      - "traefik.enable=false"

  # ===============================================
  # EchoMind Embedder - Text to Vector Embeddings
  # ===============================================
  embedder:
    image: gsantopaolo/echomind-embedder:${EMBEDDER_VERSION:-0.1.0-beta.1}
    build:
      context: ../../src
      dockerfile: embedder/Dockerfile
      args:
        - HF_TOKEN=${HF_TOKEN:-}
    container_name: echomind-embedder
    hostname: embedder
    ports:
      - "50051:50051"  # gRPC API
    env_file:
      - ${CONFIG_PATH}/embedder/embedder.env
    environment:
      - EMBEDDER_QDRANT_HOST=qdrant
      - EMBEDDER_QDRANT_PORT=6333
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 10s
      start_period: 300s
      retries: 5
    depends_on:
      qdrant:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - backend
    labels:
      - "traefik.enable=false"

  # ===============================================
  # EchoMind Orchestrator - Connector Sync Scheduler
  # ===============================================
  orchestrator:
    image: gsantopaolo/echomind-orchestrator:${ORCHESTRATOR_VERSION:-0.1.0-beta.1}
    build:
      context: ../../src
      dockerfile: orchestrator/Dockerfile
    container_name: echomind-orchestrator
    hostname: orchestrator
    env_file:
      - ${CONFIG_PATH}/orchestrator/orchestrator.env
    environment:
      - ORCHESTRATOR_DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${API_DB_NAME}
      - ORCHESTRATOR_NATS_URL=nats://nats:4222
    depends_on:
      postgres:
        condition: service_healthy
      migration:
        condition: service_completed_successfully
      nats:
        condition: service_started
    restart: unless-stopped
    networks:
      - backend
    labels:
      - "traefik.enable=false"

  # ===============================================
  # EchoMind Connector - External Data Source Fetcher
  # ===============================================
  connector:
    image: gsantopaolo/echomind-connector:${CONNECTOR_VERSION:-0.1.0-beta.1}
    build:
      context: ../../src
      dockerfile: connector/Dockerfile
    container_name: echomind-connector
    hostname: connector
    env_file:
      - ${CONFIG_PATH}/connector/connector.env
    environment:
      - CONNECTOR_DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${API_DB_NAME}
      - CONNECTOR_NATS_URL=nats://nats:4222
      - CONNECTOR_MINIO_ENDPOINT=minio:9000
      - CONNECTOR_MINIO_ACCESS_KEY=${MINIO_ROOT_USER}
      - CONNECTOR_MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD}
    depends_on:
      postgres:
        condition: service_healthy
      migration:
        condition: service_completed_successfully
      minio:
        condition: service_healthy
      nats:
        condition: service_started
      orchestrator:
        condition: service_started
    restart: unless-stopped
    networks:
      - backend
    labels:
      - "traefik.enable=false"

  # ===============================================
  # EchoMind Ingestor - Document Processing Pipeline
  # ===============================================
  ingestor:
    image: gsantopaolo/echomind-ingestor:${INGESTOR_VERSION:-0.1.0-beta.1}
    build:
      context: ../../src
      dockerfile: ingestor/Dockerfile
      args:
        - HF_TOKEN=${HF_TOKEN:-}
    container_name: echomind-ingestor
    hostname: ingestor
    env_file:
      - ${CONFIG_PATH}/ingestor/ingestor.env
    environment:
      - INGESTOR_DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${API_DB_NAME}
      - INGESTOR_NATS_URL=nats://nats:4222
      - INGESTOR_MINIO_ENDPOINT=minio:9000
      - INGESTOR_MINIO_ACCESS_KEY=${MINIO_ROOT_USER}
      - INGESTOR_MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD}
      - INGESTOR_QDRANT_HOST=qdrant
      - INGESTOR_QDRANT_PORT=6333
      - INGESTOR_EMBEDDER_HOST=embedder
      - INGESTOR_EMBEDDER_PORT=50051
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 10s
      start_period: 180s
      retries: 5
    depends_on:
      postgres:
        condition: service_healthy
      migration:
        condition: service_completed_successfully
      minio:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      nats:
        condition: service_healthy
      embedder:
        condition: service_healthy
      connector:
        condition: service_started
    restart: unless-stopped
    networks:
      - backend
    labels:
      - "traefik.enable=false"

  # ===============================================
  # EchoMind Guardian - DLQ Monitoring & Alerting
  # ===============================================
  guardian:
    image: gsantopaolo/echomind-guardian:${GUARDIAN_VERSION:-0.1.0-beta.1}
    build:
      context: ../../src
      dockerfile: guardian/Dockerfile
    container_name: echomind-guardian
    hostname: guardian
    env_file:
      - ${CONFIG_PATH}/guardian/guardian.env
    environment:
      - GUARDIAN_NATS_URL=nats://nats:4222
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3
    depends_on:
      nats:
        condition: service_healthy
      orchestrator:
        condition: service_started
    restart: unless-stopped
    networks:
      - backend
    labels:
      - "traefik.enable=false"

  # ===============================================
  # EchoMind WebUI - SvelteKit Frontend (Open WebUI Fork)
  # ===============================================
  # This is the new frontend based on Open WebUI with EchoMind extensions.
  # It connects to the EchoMind FastAPI backend via WEBUI_BASE_URL.
  webui:
    image: gsantopaolo/echomind-webui:${WEBUI_VERSION:-0.1.0-beta.1}
    build:
      context: ../../../echomind-webui
      dockerfile: Dockerfile
      args:
        - BUILD_HASH=${BUILD_HASH:-dev}
        - USE_SLIM=true
    container_name: echomind-webui
    hostname: webui
    environment:
      # Open WebUI connects to EchoMind API backend
      - WEBUI_URL=${WEBUI_URL:-http://localhost}
      - WEBUI_SECRET_KEY=${WEBUI_SECRET_KEY}
      # Disable Open WebUI's default auth - use EchoMind's Authentik OIDC
      - ENABLE_OAUTH_SIGNUP=true
      - OAUTH_PROVIDER_NAME=Authentik
      - OPENID_PROVIDER_URL=${OIDC_AUTHORITY}
      - OAUTH_CLIENT_ID=${OIDC_CLIENT_ID}
      - OAUTH_CLIENT_SECRET=${OIDC_CLIENT_SECRET}
      - OAUTH_SCOPES=openid profile email
      # EchoMind API integration
      - ECHOMIND_API_URL=http://api:8000
      # Disable features handled by EchoMind backend
      - ENABLE_RAG_WEB_LOADER_SSL_VERIFICATION=false
      - ENABLE_RAG_LOCAL_WEB_FETCH=false
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 5
    depends_on:
      api:
        condition: service_started
      authentik-server:
        condition: service_started
    restart: unless-stopped
    networks:
      - frontend
      - backend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.webui.rule=Host(`${DOMAIN}`) || Host(`webui.${DOMAIN}`)"
      - "traefik.http.routers.webui.entrypoints=web"
      - "traefik.http.services.webui.loadbalancer.server.port=8080"

  # ===============================================
  # [DEPRECATED] EchoMind Web - React Frontend
  # ===============================================
  # NOTE: DO NOT DELETE - Keep for quick rollback if needed.
  # This is the original React-based frontend. To revert:
  #   1. Comment out the 'webui' service above
  #   2. Uncomment this 'web' service
  #   3. Update Traefik labels to use web.${DOMAIN}
  # ===============================================
  # web:
  #   image: gsantopaolo/echomind-web:${WEB_VERSION:-0.1.0-beta.1}
  #   build:
  #     context: ../../src/web
  #     dockerfile: Dockerfile
  #     args:
  #       - VITE_API_BASE_URL=${API_URL}/api/v1
  #       - VITE_WS_URL=${WS_URL}
  #       - VITE_OIDC_AUTHORITY=${WEB_OIDC_AUTHORITY}
  #       - VITE_OIDC_CLIENT_ID=${WEB_OIDC_CLIENT_ID}
  #       - VITE_OIDC_REDIRECT_URI=${WEB_OIDC_REDIRECT_URI}
  #       - VITE_OIDC_POST_LOGOUT_REDIRECT_URI=${WEB_OIDC_POST_LOGOUT_REDIRECT_URI}
  #       - VITE_OIDC_SCOPE=${WEB_OIDC_SCOPE}
  #   container_name: echomind-web
  #   hostname: web
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost/health"]
  #     interval: 10s
  #     timeout: 3s
  #     start_period: 5s
  #     retries: 3
  #   depends_on:
  #     api:
  #       condition: service_started
  #     authentik-server:
  #       condition: service_started
  #   restart: unless-stopped
  #   networks:
  #     - frontend
  #   labels:
  #     - "traefik.enable=true"
  #     - "traefik.http.routers.web.rule=Host(`${DOMAIN}`) || Host(`web.${DOMAIN}`)"
  #     - "traefik.http.routers.web.entrypoints=web"
  #     - "traefik.http.services.web.loadbalancer.server.port=80"
